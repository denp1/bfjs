javascript:function mod(t,e){return t-Math.floor(t/e)*e}function getMaxPrice(t){return t?1:1e-4}function getColour(t,e){return colourChooser[mod(e,3)](e)}function refreshPrices(){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),refreshButton.dispatchEvent(t)}function getMainDoc(){return d3.select(d3.select("#site_sports").nodes()[0].contentDocument).select("#main").nodes()[0].contentDocument}function grabPrices(){var t=[];for(i=0;i<numberOfRunners;i++)t[i]={},ix=2*i,t[i].backPrice=getPrice(!0,priceButtons[ix]),t[i].layPrice=getPrice(!1,priceButtons[ix+1]),t[i].backDepth=getDepth(depthButtons[ix]),t[i].layDepth=getDepth(depthButtons[ix+1]),t[i].spread=t[i].backPrice-t[i].layPrice;return t}function getPrice(t,e){if(void 0===e)return getMaxPrice(t);var r=e.textContent.trim().replace(",","");return"&nbsp;"===r||0===r.length||"0"==r?getMaxPrice(t):1/parseFloat(r)}function getDepth(t){var e=t.textContent.trim().replace(",","");return e.length<2?0:parseFloat(e.substring(1))}function updateVolumes(){newTotal=parseFloat(totalMatched().nodes()[0].textContent.substring(4).replace(/,/g,"")),0!=lastTotal&&(tradedVolume.shift(),tradedVolume.push({time:timeSlot++,value:newTotal-lastTotal})),maxVol=0;for(var t=0;tradedVolumeElements>t;t++)maxVol=Math.max(maxVol,tradedVolume[t].value);lastTotal=newTotal}function updatePrices(){updateVolumes(),latestPrices=grabPrices();var t=latestPrices.reduce(function(t,e){return{backPrice:t.backPrice+e.backPrice}}).backPrice,e=latestPrices.reduce(function(t,e){return{layPrice:t.layPrice+e.layPrice}}).layPrice,r=latestPrices.reduce(function(t,e){return{spread:t.spread+e.spread}}).spread;for(i=0;i<numberOfRunners;i++){var n=e-latestPrices[i].layPrice,a=t-latestPrices[i].backPrice,o=Math.min(latestPrices[i].backPrice,1-n),s=Math.max(latestPrices[i].layPrice,1-a);latestPrices[i].rawRatio=(o+s)/2}var c=1-latestPrices.reduce(function(t,e){return{rawRatio:t.rawRatio+e.rawRatio}}).rawRatio;for(i=0;i<numberOfRunners;i++){latestPrices[i].overBy=latestPrices[i].spread*c/r,latestPrices[i].finalArc=latestPrices[i].overBy+latestPrices[i].rawRatio;var l=latestPrices[i].backDepth,u=latestPrices[i].layDepth;l+u===0&&(l=1,u=1);var d=latestPrices[i].spread*latestPrices[i].finalArc/2;pieSections[3*i]=(latestPrices[i].finalArc-d)*(l/(l+u)),pieSections[3*i+1]=2*d,pieSections[3*i+2]=(latestPrices[i].finalArc-d)*(u/(l+u))}}function d3Plot(){function t(t,e){return"undefined"==typeof t||0==t.length?(console.log(e),!1):!0}function e(){t(priceButtons,"priceButtons are not found"),t(runnerList,"runnerList is not found"),t(runnerLabels,"runnerLabels are not found")}function r(){pieLeftMargin=0,barMargin={top:20,right:20,bottom:20,left:40},tradedVolumeElements=27,priceButtons=d3.selectAll(".first-lay-cell .bet-button-price, .last-back-cell .bet-button-price").nodes(),depthButtons=d3.selectAll(".first-lay-cell .bet-button-size, .last-back-cell .bet-button-size").nodes(),runnerList=d3.select(".runners-container"),refreshButton=d3.select(".refresh-btn").nodes()[0],runnerLabels=runnerList.selectAll(".runner-name").nodes(),isChartShowing=function(){return null!==d3.select("#chartDiv").nodes()[0]},totalMatched=function(){return d3.select(".total-matched")},e()}function i(){u.domain([0,Math.max(maxVol,100)]),y.call(v);var t=pieHeight-barMargin.top-barMargin.bottom,e=P.selectAll("rect").data(tradedVolume,function(t){return t.time});e.enter().insert("rect","line").attr("x",function(t,e){return l(e+1)-.5}).attr("y",function(t){return u(t.value)-.5}).attr("width",barWidth).attr("height",function(e){return t-u(e.value)}).attr("fill","teal").transition().duration(1e3).attr("x",function(t,e){return l(e)-.5}),e.transition().duration(1e3).attr("x",function(t,e){return l(e)-.5}).attr("y",function(t){return u(t.value)-.5}).attr("height",function(e){return t-u(e.value)}),e.exit().remove()}function n(t,e){var r=runnerLabels[Math.floor(e/3)].innerHTML,i=latestPrices[Math.floor(e/3)];f.text(d[mod(e,3)](r,i)),f.style("visibility","visible")}function a(){isChartShowing()&&(refreshPrices(),updatePrices(),m.data(g(pieSections)),m.transition().duration(750).attrTween("d",o),i(),d3.timerFlush(),setTimeout(a,1e3))}function o(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return p(e(t))}}function s(t){var e=t,r="",i=d3.format(".0f");return t>=1e3?(e=t/1e3,r="k",0!==mod(t,1e3)&&(i=d3.format(".1f"))):t>=1e6&&(e=t/1e6,r="m",0!==mod(t,1e6)&&(i=d3.format(".1f"))),"£"+i(e)+r}if(void 0!==window.d3){r();for(var c=0;tradedVolumeElements>c;c++)tradedVolume[c]={time:timeSlot++,value:0};var l=d3.scaleLinear().domain([0,1]).range([0,barWidth]),u=d3.scaleLinear().domain([0,100]).rangeRound([pieHeight-barMargin.top-barMargin.bottom,0]),d=[function(t,e){return"£"+e.backDepth+" to Back "+t+" @ "+(1/e.backPrice).toFixed(2)},function(t){return"Spread for "+t},function(t,e){return"£"+e.layDepth+" to Lay "+t+" @ "+(1/e.layPrice).toFixed(2)}];runnerList.insert("div",":first-child").attr("id","chartDiv"),numberOfRunners=priceButtons.length/2,pieSections=[3*numberOfRunners];var b=runnerList.select("#chartDiv");updatePrices(),colour=9>numberOfRunners?d3.scaleOrdinal().range(colorbrewer[numberOfRunners+1]):function(t){return d3.schemeCategory20[t]};var g=d3.pie().sort(null),p=d3.arc().innerRadius(pieRadius-40).outerRadius(pieRadius),f=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FAFCC5").style("opacity","0.85").style("font-size","12px").style("padding","3px"),h=b.append("svg").attr("width",pieWidth+pieLeftMargin).attr("height",pieHeight).append("g").attr("transform","translate("+(pieWidth/2+pieLeftMargin)+","+pieHeight/2+")"),m=h.selectAll("path").data(g(pieSections)).enter().append("path").attr("fill",getColour).on("mouseover",n).on("mousemove",function(){return f.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return f.style("visibility","hidden")}).attr("d",p).each(function(t){this._current=t}),P=b.append("svg").attr("class","chart").attr("width","75%").attr("height",pieHeight).attr("y",10).append("g").attr("transform","translate("+barMargin.left+", "+barMargin.top+")");P.append("line").attr("x1",0).attr("x2",barWidth*(tradedVolume.length+1)).attr("y1",pieHeight+.5).attr("y2",pieHeight+.5).attr("stroke-width",.5).style("stroke","#000").attr("transform","translate(0, -40)");var v=d3.axisLeft().scale(u).ticks(3).tickFormat(s),y=P.append("g").call(v);y.selectAll("path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),setTimeout(a,1e3)}}var colorbrewer={3:["rgb(252,141,89)","rgb(255,255,191)","rgb(153,213,148)"],4:["rgb(215,25,28)","rgb(253,174,97)","rgb(171,221,164)","rgb(43,131,186)"],5:["rgb(215,25,28)","rgb(253,174,97)","rgb(255,255,191)","rgb(171,221,164)","rgb(43,131,186)"],6:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],7:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],8:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],9:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],10:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"],11:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"]},pieWidth=160,pieHeight=200,pieLeftMargin,pieRadius=Math.min(pieWidth,pieHeight)/2,pieSections,barWidth=16,barMargin,tradedVolumeElements,runnerList,refreshButton,priceButtons,runnerLabels,latestPrices,numberOfRunners,colour,tradedVolume=[],timeSlot=0,lastTotal=0,maxVol=100,isChartShowing,colourChooser=[function(t){return d3.rgb(colour(Math.floor(t/3))).darker(.3)},function(){return colour(numberOfRunners)},function(t){return d3.rgb(colour(Math.floor(t/3))).brighter(.3)}];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.addEventListener("load",d3Plot,!1),t.src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js",document.body.appendChild(t)}();