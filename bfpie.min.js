javascript:var colorbrewer={3:["rgb(252,141,89)","rgb(255,255,191)","rgb(153,213,148)"],4:["rgb(215,25,28)","rgb(253,174,97)","rgb(171,221,164)","rgb(43,131,186)"],5:["rgb(215,25,28)","rgb(253,174,97)","rgb(255,255,191)","rgb(171,221,164)","rgb(43,131,186)"],6:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],7:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],8:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],9:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],10:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"],11:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"]},pieWidth=160,pieHeight=200,pieLeftMargin,pieRadius=Math.min(pieWidth,pieHeight)/2,pieSections,barWidth=16,barMargin,tradedVolumeElements,runnerList,refreshButton,priceButtons,runnerLabels,latestPrices,numberOfRunners,colour,tradedVolume=[],timeSlot=0,lastTotal=0,maxVol=100;var updatePriceButtons,getDepthButton,getPriceButton,getTooltipContainer,isChartShowing;function isD3Loaded(){return(window.d3!==undefined)}function mod(b,a){return b-(Math.floor(b/a)*a)}function getMaxPrice(a){return a?1:1/10000}var colourChooser=[function(a){return d3.rgb(colour(Math.floor(a/3))).darker(0.3)},function(a){return colour(numberOfRunners)},function(a){return d3.rgb(colour(Math.floor(a/3))).brighter(0.3)}];function getColour(b,a){return colourChooser[mod(a,3)](a)}function waitTillD3Loaded(){if(isD3Loaded()){d3Plot()}else{setTimeout(waitTillD3Loaded,250)}}function refreshPrices(){var a=document.createEvent("MouseEvents");a.initEvent("click",true,false);refreshButton.dispatchEvent(a)}function getMainDoc(){return d3.select(d3.select("#site_sports")[0][0].contentDocument).select("#main")[0][0].contentDocument}function grabPrices(){var c=[];for(i=0;i<numberOfRunners;i++){c[i]={};var b=priceButtons[2*i];var a=priceButtons[(2*i)+1];c[i].backPrice=getPrice(true,b);c[i].layPrice=getPrice(false,a);c[i].spread=c[i].backPrice-c[i].layPrice;c[i].backDepth=getDepth(b);c[i].layDepth=getDepth(a)}return c}function getPrice(d,b){var c=b.childNodes[getPriceButton(b.childNodes.length)];if(c===undefined){return getMaxPrice(d)}var a=c.textContent.trim().replace(",","");if((a==="&nbsp;")||(a.length===0)){return getMaxPrice(d)}else{return 1/parseFloat(a)}}function getDepth(b){var c=b.childNodes[getDepthButton(b.childNodes.length)];if(c===undefined){return 0}var a=c.textContent.trim().replace(",","");return(a.length<2)?0:parseFloat(a.substring(1))}function updateVolumes(){newTotal=parseFloat(totalMatched()[0][0].textContent.substring(4).replace(/,/g,""));if(lastTotal!=0){tradedVolume.shift();tradedVolume.push({time:timeSlot++,value:newTotal-lastTotal})}maxVol=0;for(var a=0;a<tradedVolumeElements;a++){maxVol=Math.max(maxVol,tradedVolume[a].value)}lastTotal=newTotal}function updatePrices(){updateVolumes();priceButtons=updatePriceButtons();latestPrices=grabPrices();var d=latestPrices.reduce(function(n,m){return{backPrice:n.backPrice+m.backPrice}}).backPrice,g=latestPrices.reduce(function(n,m){return{layPrice:n.layPrice+m.layPrice}}).layPrice,e=latestPrices.reduce(function(n,m){return{spread:n.spread+m.spread}}).spread;for(i=0;i<numberOfRunners;i++){var k=g-latestPrices[i].layPrice,b=d-latestPrices[i].backPrice,h=Math.min(latestPrices[i].backPrice,1-k),f=Math.max(latestPrices[i].layPrice,1-b);latestPrices[i].rawRatio=(h+f)/2}var l=1-latestPrices.reduce(function(n,m){return{rawRatio:n.rawRatio+m.rawRatio}}).rawRatio;for(i=0;i<numberOfRunners;i++){latestPrices[i].overBy=latestPrices[i].spread*l/e;latestPrices[i].finalArc=latestPrices[i].overBy+latestPrices[i].rawRatio;var c=latestPrices[i].backDepth;var a=latestPrices[i].layDepth;if((c+a)===0){c=1;a=1}var j=latestPrices[i].spread*latestPrices[i].finalArc/2;pieSections[(i*3)]=(latestPrices[i].finalArc-j)*(c/(c+a));pieSections[(i*3)+1]=j*2;pieSections[(i*3)+2]=(latestPrices[i].finalArc-j)*(a/(c+a))}}function d3Plot(){function e(){if(l){pieLeftMargin=0;barMargin={top:20,right:20,bottom:20,left:40};tradedVolumeElements=27;priceButtons=d3.selectAll(".cta-back, .cta-lay")[0];runnerList=d3.select(".cont-runners");refreshButton=d3.select(".mkt-refresh-btn")[0][0];runnerLabels=runnerList.selectAll(".sel-name")[0];updatePriceButtons=function(){return priceButtons};getDepthButton=function(w){return 3};getPriceButton=function(w){return 1};getTooltipContainer=function(){return d3.select("body")};isChartShowing=function(){return d3.select("#chartDiv")[0][0]!==null};totalMatched=function(){return d3.select(".total-matched-val")}}else{pieLeftMargin=10;barMargin={top:20,right:20,bottom:20,left:40};tradedVolumeElements=30;var v=getMainDoc();updatePriceButtons=function(){return runnerList.selectAll(".l1 .buttonAppearance,.b1 .buttonAppearance")[0]};runnerList=d3.select(v).select("#runnerList");refreshButton=d3.select(v).select("#m1_btnRefresh")[0][0];priceButtons=updatePriceButtons();runnerLabels=runnerList.selectAll(".runnerName")[0];getDepthButton=function(w){return w-1};getPriceButton=function(w){return w-2};getTooltipContainer=function(){return b};isChartShowing=function(){return getMainDoc().getElementById("chartDiv")!==null};totalMatched=function(){return d3.select(v).select("#m1_TotalMoneyMatched")}}}var l=d3.select(".cont-runners")[0][0]!==null;e(l);for(var t=0;t<tradedVolumeElements;t++){tradedVolume[t]={time:timeSlot++,value:0}}var k=d3.scale.linear().domain([0,1]).range([0,barWidth]);var j=d3.scale.linear().domain([0,100]).rangeRound([pieHeight-barMargin.top-barMargin.bottom,0]);function s(){j.domain([0,Math.max(maxVol,100)]);u.call(a);var v=pieHeight-barMargin.top-barMargin.bottom;var w=p.selectAll("rect").data(tradedVolume,function(x){return x.time});w.enter().insert("rect","line").attr("x",function(y,x){return k(x+1)-0.5}).attr("y",function(x){return j(x.value)-0.5}).attr("width",barWidth).attr("height",function(x){return v-j(x.value)}).attr("fill","teal").transition().duration(1000).attr("x",function(y,x){return k(x)-0.5});w.transition().duration(1000).attr("x",function(y,x){return k(x)-0.5}).attr("y",function(x){return j(x.value)-0.5}).attr("height",function(x){return v-j(x.value)});w.exit().remove()}var n=[function(v,w){return"£"+w.backDepth+" to Back "+v+" @ "+(1/w.backPrice).toFixed(2)},function(v,w){return"Spread for "+v},function(v,w){return"£"+w.layDepth+" to Lay "+v+" @ "+(1/w.layPrice).toFixed(2)}];function g(y,v){var w=runnerLabels[Math.floor(v/3)].innerHTML;var x=latestPrices[Math.floor(v/3)];d.text(n[mod(v,3)](w,x));d.style("visibility","visible")}function m(){if(!isChartShowing()){return}refreshPrices();updatePrices();r.data(o(pieSections));r.transition().duration(750).attrTween("d",c);s();d3.timer.flush();setTimeout(m,1000)}function c(v){var w=d3.interpolate(this._current,v);this._current=w(0);return function(x){return f(w(x))}}runnerList.insert("div",":first-child").attr("id","chartDiv");numberOfRunners=priceButtons.length/2;pieSections=[numberOfRunners*3];var b=runnerList.select("#chartDiv");updatePrices();if(numberOfRunners<9){colour=d3.scale.ordinal().range(colorbrewer[numberOfRunners+1])}else{colour=d3.scale.category20()}var o=d3.layout.pie().sort(null);var f=d3.svg.arc().innerRadius(pieRadius-40).outerRadius(pieRadius);var d=getTooltipContainer().append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FAFCC5").style("opacity","0.85").style("font-size","12px").style("padding","3px");var q=b.append("svg").attr("width",pieWidth+pieLeftMargin).attr("height",pieHeight).append("g").attr("transform","translate("+((pieWidth/2)+pieLeftMargin)+","+pieHeight/2+")");var r=q.selectAll("path").data(o(pieSections)).enter().append("path").attr("fill",getColour).on("mouseover",g).on("mousemove",function(){return d.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px")}).on("mouseout",function(){return d.style("visibility","hidden")}).attr("d",f).each(function(v){this._current=v});var p=b.append("svg").attr("class","chart").attr("width",(barWidth*tradedVolume.length)+barMargin.left+barMargin.right).attr("height",pieHeight).attr("y",10).append("g").attr("transform","translate("+barMargin.left+", "+barMargin.top+")");p.append("line").attr("x1",0).attr("x2",barWidth*(tradedVolume.length+1)).attr("y1",pieHeight+0.5).attr("y2",pieHeight+0.5).attr("stroke-width",0.5).style("stroke","#000").attr("transform","translate(0, -40)");var a=d3.svg.axis().orient("left").scale(j).ticks(3).tickFormat(h);function h(y){var v=y;var w="";var x=d3.format(".0f");if(y>=1000){v=y/1000;w="k";if(mod(y,1000)!==0){x=d3.format(".1f")}}else{if(y>=1000000){v=y/1000000;w="m";if(mod(y,1000000)!==0){x=d3.format(".1f")}}}return"£"+x(v)+w}var u=p.append("g").call(a);u.selectAll("path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges");setTimeout(m,1000)}(function(){if(!isD3Loaded()){document.body.appendChild(document.createElement("script")).src="http://d3js.org/d3.v3.min.js"}waitTillD3Loaded()})();