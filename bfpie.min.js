var colorbrewer={3:["rgb(252,141,89)","rgb(255,255,191)","rgb(153,213,148)"],4:["rgb(215,25,28)","rgb(253,174,97)","rgb(171,221,164)","rgb(43,131,186)"],5:["rgb(215,25,28)","rgb(253,174,97)","rgb(255,255,191)","rgb(171,221,164)","rgb(43,131,186)"],6:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],7:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],8:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],9:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],10:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"],11:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"]},width=350,height=200,radius=Math.min(width,height)/2,sections,runnerList,refreshButton,priceButtons,runnerLabels,latestprices,numberOfRunners,colour;var updatePriceButtons,getDepthButton,getPriceButton,getTooltipContainer,isChartShowing;function isD3Loaded(){return(window.d3!==undefined)}function mod(b,a){return b-(Math.floor(b/a)*a)}function getMaxPrice(a){return a?1:1/10000}var colourChooser=[function(a){return d3.rgb(colour(Math.floor(a/3))).darker(0.3)},function(a){return colour(numberOfRunners)},function(a){return d3.rgb(colour(Math.floor(a/3))).brighter(0.3)}];function getColour(b,a){return colourChooser[mod(a,3)](a)}function waitTillD3Loaded(){if(isD3Loaded()){d3Plot()}else{setTimeout(waitTillD3Loaded,250)}}function refreshPrices(){var a=document.createEvent("MouseEvents");a.initEvent("click",true,false);refreshButton.dispatchEvent(a)}function getMainDoc(){return d3.select(d3.select("#site_sports")[0][0].contentDocument).select("#main")[0][0].contentDocument}function grabPrices(){var c=[];for(i=0;i<numberOfRunners;i++){c[i]={};var b=priceButtons[2*i];var a=priceButtons[(2*i)+1];c[i].backPrice=getPrice(true,b);c[i].layPrice=getPrice(false,a);c[i].spread=c[i].backPrice-c[i].layPrice;c[i].backDepth=getDepth(b);c[i].layDepth=getDepth(a)}return c}function getPrice(c,b){var a=b.childNodes[getPriceButton(b.childNodes.length)].textContent.trim().replace(",","");if((a==="&nbsp;")||(a.length===0)){return getMaxPrice(c)}else{return 1/parseFloat(a)}}function getDepth(b){var a=b.childNodes[getDepthButton(b.childNodes.length)].textContent.trim().replace(",","");return(a.length<2)?0:parseFloat(a.substring(1))}function updatePrices(){priceButtons=updatePriceButtons();latestprices=grabPrices();var d=latestprices.reduce(function(n,m){return{backPrice:n.backPrice+m.backPrice}}).backPrice,g=latestprices.reduce(function(n,m){return{layPrice:n.layPrice+m.layPrice}}).layPrice,e=latestprices.reduce(function(n,m){return{spread:n.spread+m.spread}}).spread;for(i=0;i<numberOfRunners;i++){var k=g-latestprices[i].layPrice,b=d-latestprices[i].backPrice,h=Math.min(latestprices[i].backPrice,1-k),f=Math.max(latestprices[i].layPrice,1-b);latestprices[i].rawRatio=(h+f)/2}var l=1-latestprices.reduce(function(n,m){return{rawRatio:n.rawRatio+m.rawRatio}}).rawRatio;for(i=0;i<numberOfRunners;i++){latestprices[i].overBy=latestprices[i].spread*l/e;latestprices[i].finalArc=latestprices[i].overBy+latestprices[i].rawRatio;var c=latestprices[i].backDepth;var a=latestprices[i].layDepth;if((c+a)===0){c=1;a=1}var j=latestprices[i].spread*latestprices[i].finalArc/2;sections[(i*3)]=(latestprices[i].finalArc-j)*(c/(c+a));sections[(i*3)+1]=j*2;sections[(i*3)+2]=(latestprices[i].finalArc-j)*(a/(c+a))}}function d3Plot(){function j(){if(g){priceButtons=d3.selectAll(".cta-back, .cta-lay")[0];runnerList=d3.select(".cont-runners");refreshButton=d3.select(".mkt-refresh-btn")[0][0];runnerLabels=runnerList.selectAll(".sel-name")[0];updatePriceButtons=function(){return priceButtons};getDepthButton=function(o){return 3};getPriceButton=function(o){return 1};getTooltipContainer=function(){return d3.select("body")};isChartShowing=function(){return d3.select("#chartDiv")[0][0]!==null}}else{var n=getMainDoc();updatePriceButtons=function(){return runnerList.selectAll(".l1 .buttonAppearance,.b1 .buttonAppearance")[0]};runnerList=d3.select(n).select("#runnerList");refreshButton=d3.select(n).select("#m1_btnRefresh")[0][0];priceButtons=updatePriceButtons();runnerLabels=runnerList.selectAll(".runnerName")[0];getDepthButton=function(o){return o-1};getPriceButton=function(o){return o-2};getTooltipContainer=function(){return c};isChartShowing=function(){return getMainDoc().getElementById("chartDiv")!==null}}}var a=[function(n,o){return"£"+o.backDepth+" to Back "+n+" @ "+(1/o.backPrice).toFixed(2)},function(n,o){return"Spread for "+n},function(n,o){return"£"+o.layDepth+" to Lay "+n+" @ "+(1/o.layPrice).toFixed(2)}];function m(q,n){var o=runnerLabels[Math.floor(n/3)].innerHTML;var p=latestprices[Math.floor(n/3)];l.text(a[mod(n,3)](o,p));l.style("visibility","visible")}function h(){if(!isChartShowing()){return}refreshPrices();updatePrices();k.data(d(sections));k.transition().duration(750).attrTween("d",f);setTimeout(h,1000)}function f(n){var o=d3.interpolate(this._current,n);this._current=o(0);return function(p){return b(o(p))}}var g=d3.select(".cont-runners")[0][0]!==null;j(g);runnerList.insert("div",":first-child").attr("align","center").attr("id","chartDiv");numberOfRunners=priceButtons.length/2;sections=[numberOfRunners*3];var c=runnerList.select("#chartDiv");updatePrices();if(numberOfRunners<9){colour=d3.scale.ordinal().range(colorbrewer[numberOfRunners+1])}else{colour=d3.scale.category20()}var d=d3.layout.pie().sort(null);var b=d3.svg.arc().innerRadius(radius-60).outerRadius(radius-20);var l=getTooltipContainer().append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FAFCC5").style("opacity","0.85").style("font-size","12px").style("padding","3px");var e=c.append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")");var k=e.selectAll("path").data(d(sections)).enter().append("path").attr("fill",getColour).on("mouseover",m).on("mousemove",function(){return l.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px")}).on("mouseout",function(){return l.style("visibility","hidden")}).attr("d",b).each(function(n){this._current=n});setTimeout(h,1000)}(function(){if(!isD3Loaded()){document.body.appendChild(document.createElement("script")).src="http://d3js.org/d3.v3.min.js"}waitTillD3Loaded()})();
