<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Slate is a responsive theme for GitHub Pages" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>BFJS: Betfair Javascript Charts</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/denp1/bfjs">View on GitHub</a>

          <h1 id="project_title">BFJS</h1>
          <h2 id="project_tagline">Betfair Javascript Charts</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <img alt="Betfair Charts in use" src="chart_screenshot.png" />
        <p>To use this bookmarklet, drag this <a href='javascript:var colorbrewer={3:["rgb(252,141,89)","rgb(255,255,191)","rgb(153,213,148)"],4:["rgb(215,25,28)","rgb(253,174,97)","rgb(171,221,164)","rgb(43,131,186)"],5:["rgb(215,25,28)","rgb(253,174,97)","rgb(255,255,191)","rgb(171,221,164)","rgb(43,131,186)"],6:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],7:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],8:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],9:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],10:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"],11:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"]},pieWidth=160,pieHeight=200,pieLeftMargin,pieRadius=Math.min(pieWidth,pieHeight)/2,pieSections,barWidth=16,barMargin,tradedVolumeElements,runnerList,refreshButton,priceButtons,runnerLabels,latestPrices,numberOfRunners,colour,tradedVolume=[],timeSlot=0,lastTotal=0,maxVol=100;var isChartShowing;function mod(b,a){return b-(Math.floor(b/a)*a)}function getMaxPrice(a){return a?1:1/10000}var colourChooser=[function(a){return d3.rgb(colour(Math.floor(a/3))).darker(0.3)},function(){return colour(numberOfRunners)},function(a){return d3.rgb(colour(Math.floor(a/3))).brighter(0.3)}];function getColour(b,a){return colourChooser[mod(a,3)](a)}function refreshPrices(){var a=document.createEvent("MouseEvents");a.initEvent("click",true,false);refreshButton.dispatchEvent(a)}function getMainDoc(){return d3.select(d3.select("#site_sports").nodes()[0].contentDocument).select("#main").nodes()[0].contentDocument}function grabPrices(){var a=[];for(i=0;i<numberOfRunners;i++){a[i]={};ix=2*i;a[i].backPrice=getPrice(true,priceButtons[ix]);a[i].layPrice=getPrice(false,priceButtons[ix+1]);a[i].backDepth=getDepth(depthButtons[ix]);a[i].layDepth=getDepth(depthButtons[ix+1]);a[i].spread=a[i].backPrice-a[i].layPrice}return a}function getPrice(c,b){if(b===undefined){return getMaxPrice(c)}var a=b.textContent.trim().replace(",","");if((a==="&nbsp;")||(a.length===0)||(a=="0")){return getMaxPrice(c)}else{return 1/parseFloat(a)}}function getDepth(b){var a=b.textContent.trim().replace(",","");return(a.length<2)?0:parseFloat(a.substring(1))}function updateVolumes(){newTotal=parseFloat(totalMatched().nodes()[0].textContent.substring(4).replace(/,/g,""));if(lastTotal!=0){tradedVolume.shift();tradedVolume.push({time:timeSlot++,value:newTotal-lastTotal})}maxVol=0;for(var a=0;a<tradedVolumeElements;a++){maxVol=Math.max(maxVol,tradedVolume[a].value)}lastTotal=newTotal}function updatePrices(){updateVolumes();latestPrices=grabPrices();var d=latestPrices.reduce(function(n,m){return{backPrice:n.backPrice+m.backPrice}}).backPrice,g=latestPrices.reduce(function(n,m){return{layPrice:n.layPrice+m.layPrice}}).layPrice,e=latestPrices.reduce(function(n,m){return{spread:n.spread+m.spread}}).spread;for(i=0;i<numberOfRunners;i++){var k=g-latestPrices[i].layPrice,b=d-latestPrices[i].backPrice,h=Math.min(latestPrices[i].backPrice,1-k),f=Math.max(latestPrices[i].layPrice,1-b);latestPrices[i].rawRatio=(h+f)/2}var l=1-latestPrices.reduce(function(n,m){return{rawRatio:n.rawRatio+m.rawRatio}}).rawRatio;for(i=0;i<numberOfRunners;i++){latestPrices[i].overBy=latestPrices[i].spread*l/e;latestPrices[i].finalArc=latestPrices[i].overBy+latestPrices[i].rawRatio;var c=latestPrices[i].backDepth;var a=latestPrices[i].layDepth;if((c+a)===0){c=1;a=1}var j=latestPrices[i].spread*latestPrices[i].finalArc/2;pieSections[(i*3)]=(latestPrices[i].finalArc-j)*(c/(c+a));pieSections[(i*3)+1]=j*2;pieSections[(i*3)+2]=(latestPrices[i].finalArc-j)*(a/(c+a))}}function d3Plot(){if(window.d3===undefined){return}function s(w,x){if((typeof w=="undefined")||(w.length==0)){console.log(x);return false}return true}function v(){s(priceButtons,"priceButtons are not found");s(runnerList,"runnerList is not found");s(runnerLabels,"runnerLabels are not found")}function e(){pieLeftMargin=0;barMargin={top:20,right:20,bottom:20,left:40};tradedVolumeElements=27;priceButtons=d3.selectAll(".first-lay-cell .bet-button-price, .last-back-cell .bet-button-price").nodes();depthButtons=d3.selectAll(".first-lay-cell .bet-button-size, .last-back-cell .bet-button-size").nodes();runnerList=d3.select(".runners-container");refreshButton=d3.select(".refresh-btn").nodes()[0];runnerLabels=d3.selectAll(".runner-name").nodes();isChartShowing=function(){return d3.select("#chartDiv").nodes()[0]!==null};totalMatched=function(){return d3.select(".total-matched")};v()}e();for(var t=0;t<tradedVolumeElements;t++){tradedVolume[t]={time:timeSlot++,value:0}}var k=d3.scaleLinear().domain([0,1]).range([0,barWidth]);var j=d3.scaleLinear().domain([0,100]).rangeRound([pieHeight-barMargin.top-barMargin.bottom,0]);function r(){j.domain([0,Math.max(maxVol,100)]);u.call(a);var w=pieHeight-barMargin.top-barMargin.bottom;var x=o.selectAll("rect").data(tradedVolume,function(y){return y.time});x.enter().insert("rect","line").attr("x",function(z,y){return k(y+1)-0.5}).attr("y",function(y){return j(y.value)-0.5}).attr("width",barWidth).attr("height",function(y){return w-j(y.value)}).attr("fill","teal").transition().duration(1000).attr("x",function(z,y){return k(y)-0.5});x.transition().duration(1000).attr("x",function(z,y){return k(y)-0.5}).attr("y",function(y){return j(y.value)-0.5}).attr("height",function(y){return w-j(y.value)});x.exit().remove()}var m=[function(w,x){return"£"+x.backDepth+" to Back "+w+" @ "+(1/x.backPrice).toFixed(2)},function(w){return"Spread for "+w},function(w,x){return"£"+x.layDepth+" to Lay "+w+" @ "+(1/x.layPrice).toFixed(2)}];function g(z,w){var x=runnerLabels[Math.floor(w/3)].innerHTML;var y=latestPrices[Math.floor(w/3)];d.text(m[mod(w,3)](x,y));d.style("visibility","visible")}function l(){if(!isChartShowing()){return}refreshPrices();updatePrices();q.data(n(pieSections));q.transition().duration(750).attrTween("d",c);r();d3.timerFlush();setTimeout(l,1000)}function c(w){var x=d3.interpolate(this._current,w);this._current=x(0);return function(y){return f(x(y))}}runnerList.insert("div",":first-child").attr("id","chartDiv");numberOfRunners=priceButtons.length/2;pieSections=[numberOfRunners*3];var b=runnerList.select("#chartDiv");updatePrices();if(numberOfRunners<9){colour=d3.scaleOrdinal().range(colorbrewer[numberOfRunners+1])}else{colour=function(w){return d3.schemeCategory20[w]}}var n=d3.pie().sort(null);var f=d3.arc().innerRadius(pieRadius-40).outerRadius(pieRadius);var d=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FAFCC5").style("opacity","0.85").style("font-size","12px").style("padding","3px");var p=b.append("svg").attr("width",pieWidth+pieLeftMargin).attr("height",pieHeight).append("g").attr("transform","translate("+((pieWidth/2)+pieLeftMargin)+","+pieHeight/2+")");var q=p.selectAll("path").data(n(pieSections)).enter().append("path").attr("fill",getColour).on("mouseover",g).on("mousemove",function(){return d.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px")}).on("mouseout",function(){return d.style("visibility","hidden")}).attr("d",f).each(function(w){this._current=w});var o=b.append("svg").attr("class","chart").attr("width","75%").attr("height",pieHeight).attr("y",10).append("g").attr("transform","translate("+barMargin.left+", "+barMargin.top+")");o.append("line").attr("x1",0).attr("x2",barWidth*(tradedVolume.length+1)).attr("y1",pieHeight+0.5).attr("y2",pieHeight+0.5).attr("stroke-width",0.5).style("stroke","#000").attr("transform","translate(0, -40)");var a=d3.axisLeft().scale(j).ticks(3).tickFormat(h);function h(z){var w=z;var x="";var y=d3.format(".0f");if(z>=1000){w=z/1000;x="k";if(mod(z,1000)!==0){y=d3.format(".1f")}}else{if(z>=1000000){w=z/1000000;x="m";if(mod(z,1000000)!==0){y=d3.format(".1f")}}}return"£"+y(w)+x}var u=o.append("g").call(a);u.selectAll("path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges");setTimeout(l,1000)}(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.addEventListener("load",d3Plot,false);a.src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js";document.body.appendChild(a)})();'>Betfair Charts</a> link onto your bookmark bar.  Then, on the Betfair web site, log in and navigate to a "Win Only Market" (i.e. not any form of Handicap market or other variant) such as football Match Odds, or Correct Score and click on the bookmark.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Slate theme maintained by <a href="https://github.com/jsncostello">Jason Costello</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

  </body>
</html>
c
