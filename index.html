<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Slate is a responsive theme for GitHub Pages" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>BFJS: Betfair Javascript Charts</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/denp1/bfjs">View on GitHub</a>

          <h1 id="project_title">BFJS</h1>
          <h2 id="project_tagline">Betfair Javascript Charts</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <img alt="Betfair Charts in use" src="chart_screenshot.png" />
        <p>To use this bookmarklet, drag this <a href='javascript:function mod(t,e){return t-Math.floor(t/e)*e}function getMaxPrice(t){return t?1:1e-4}function getColour(t,e){return colourChooser[mod(e,3)](e)}function refreshPrices(){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),refreshButton.dispatchEvent(t)}function getMainDoc(){return d3.select(d3.select("#site_sports")[0][0].contentDocument).select("#main")[0][0].contentDocument}function grabPrices(){var t=[];for(i=0;i<numberOfRunners;i++){t[i]={};var e=priceButtons[2*i],r=priceButtons[2*i+1];t[i].backPrice=getPrice(!0,e),t[i].layPrice=getPrice(!1,r),t[i].backDepth=getDepth(e),t[i].layDepth=getDepth(r),t[i].spread=t[i].backPrice-t[i].layPrice}return t}function getPrice(t,e){var r=e.childNodes[getPriceButton(e.childNodes.length)];if(void 0===r)return getMaxPrice(t);var n=r.textContent.trim().replace(",","");return"&nbsp;"===n||0===n.length?getMaxPrice(t):1/parseFloat(n)}function getDepth(t){var e=t.childNodes[getDepthButton(t.childNodes.length)];if(void 0===e)return 0;var r=e.textContent.trim().replace(",","");return r.length<2?0:parseFloat(r.substring(1))}function updateVolumes(){newTotal=parseFloat(totalMatched()[0][0].textContent.substring(4).replace(/,/g,"")),0!=lastTotal&&(tradedVolume.shift(),tradedVolume.push({time:timeSlot++,value:newTotal-lastTotal})),maxVol=0;for(var t=0;tradedVolumeElements>t;t++)maxVol=Math.max(maxVol,tradedVolume[t].value);lastTotal=newTotal}function updatePrices(){updateVolumes(),priceButtons=updatePriceButtons(),latestPrices=grabPrices();var t=latestPrices.reduce(function(t,e){return{backPrice:t.backPrice+e.backPrice}}).backPrice,e=latestPrices.reduce(function(t,e){return{layPrice:t.layPrice+e.layPrice}}).layPrice,r=latestPrices.reduce(function(t,e){return{spread:t.spread+e.spread}}).spread;for(i=0;i<numberOfRunners;i++){var n=e-latestPrices[i].layPrice,a=t-latestPrices[i].backPrice,o=Math.min(latestPrices[i].backPrice,1-n),s=Math.max(latestPrices[i].layPrice,1-a);latestPrices[i].rawRatio=(o+s)/2}var u=1-latestPrices.reduce(function(t,e){return{rawRatio:t.rawRatio+e.rawRatio}}).rawRatio;for(i=0;i<numberOfRunners;i++){latestPrices[i].overBy=latestPrices[i].spread*u/r,latestPrices[i].finalArc=latestPrices[i].overBy+latestPrices[i].rawRatio;var c=latestPrices[i].backDepth,l=latestPrices[i].layDepth;c+l===0&&(c=1,l=1);var d=latestPrices[i].spread*latestPrices[i].finalArc/2;pieSections[3*i]=(latestPrices[i].finalArc-d)*(c/(c+l)),pieSections[3*i+1]=2*d,pieSections[3*i+2]=(latestPrices[i].finalArc-d)*(l/(c+l))}}function d3Plot(){function t(t,e){return"undefined"==typeof t||0==t.length?(console.log(e),!1):!0}function e(){t(priceButtons,"priceButtons are not found"),t(runnerList,"runnerList is not found"),t(runnerLabels,"runnerLabels are not found")}function r(){if(isNewSite)pieLeftMargin=0,barMargin={top:20,right:20,bottom:20,left:40},tradedVolumeElements=27,priceButtons=d3.selectAll(".bet-buttons")[0],filterFn=function(t,e){return m=mod(e,6),2==m||3==m},priceButtons=priceButtons.filter(filterFn),runnerList=d3.select(".runners-container"),refreshButton=d3.select(".refresh-btn")[0][0],runnerLabels=runnerList.selectAll(".runner-name")[0],updatePriceButtons=function(){return priceButtons},getDepthButton=function(){return 2},getPriceButton=function(){return 0},getTooltipContainer=function(){return d3.select("body")},isChartShowing=function(){return null!==d3.select("#chartDiv")[0][0]},totalMatched=function(){return d3.select(".total-matched")},e();else{pieLeftMargin=10,barMargin={top:20,right:20,bottom:20,left:40},tradedVolumeElements=30;var t=getMainDoc();updatePriceButtons=function(){return runnerList.selectAll(".l1 .buttonAppearance,.b1 .buttonAppearance")[0]},runnerList=d3.select(t).select("#runnerList"),refreshButton=d3.select(t).select("#m1_btnRefresh")[0][0],priceButtons=updatePriceButtons(),runnerLabels=runnerList.selectAll(".runnerName")[0],getDepthButton=function(t){return t-1},getPriceButton=function(t){return t-2},getTooltipContainer=function(){return g},isChartShowing=function(){return null!==getMainDoc().getElementById("chartDiv")},totalMatched=function(){return d3.select(t).select("#m1_TotalMoneyMatched")},e()}}function n(){l.domain([0,Math.max(maxVol,100)]),M.call(y);var t=pieHeight-barMargin.top-barMargin.bottom,e=v.selectAll("rect").data(tradedVolume,function(t){return t.time});e.enter().insert("rect","line").attr("x",function(t,e){return c(e+1)-.5}).attr("y",function(t){return l(t.value)-.5}).attr("width",barWidth).attr("height",function(e){return t-l(e.value)}).attr("fill","teal").transition().duration(1e3).attr("x",function(t,e){return c(e)-.5}),e.transition().duration(1e3).attr("x",function(t,e){return c(e)-.5}).attr("y",function(t){return l(t.value)-.5}).attr("height",function(e){return t-l(e.value)}),e.exit().remove()}function i(t,e){var r=runnerLabels[Math.floor(e/3)].innerHTML,n=latestPrices[Math.floor(e/3)];f.text(d[mod(e,3)](r,n)),f.style("visibility","visible")}function a(){isChartShowing()&&(refreshPrices(),updatePrices(),P.data(p(pieSections)),P.transition().duration(750).attrTween("d",o),n(),d3.timer.flush(),setTimeout(a,1e3))}function o(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return b(e(t))}}function s(t){var e=t,r="",n=d3.format(".0f");return t>=1e3?(e=t/1e3,r="k",0!==mod(t,1e3)&&(n=d3.format(".1f"))):t>=1e6&&(e=t/1e6,r="m",0!==mod(t,1e6)&&(n=d3.format(".1f"))),"£"+n(e)+r}if(void 0!==window.d3){isNewSite=null!==d3.select(".runners-container")[0][0],r(isNewSite);for(var u=0;tradedVolumeElements>u;u++)tradedVolume[u]={time:timeSlot++,value:0};var c=d3.scale.linear().domain([0,1]).range([0,barWidth]),l=d3.scale.linear().domain([0,100]).rangeRound([pieHeight-barMargin.top-barMargin.bottom,0]),d=[function(t,e){return"£"+e.backDepth+" to Back "+t+" @ "+(1/e.backPrice).toFixed(2)},function(t){return"Spread for "+t},function(t,e){return"£"+e.layDepth+" to Lay "+t+" @ "+(1/e.layPrice).toFixed(2)}];runnerList.insert("div",":first-child").attr("id","chartDiv"),numberOfRunners=priceButtons.length/2,pieSections=[3*numberOfRunners];var g=runnerList.select("#chartDiv");updatePrices(),colour=9>numberOfRunners?d3.scale.ordinal().range(colorbrewer[numberOfRunners+1]):d3.scale.category20();var p=d3.layout.pie().sort(null),b=d3.svg.arc().innerRadius(pieRadius-40).outerRadius(pieRadius),f=getTooltipContainer().append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FAFCC5").style("opacity","0.85").style("font-size","12px").style("padding","3px"),h=g.append("svg").attr("width",pieWidth+pieLeftMargin).attr("height",pieHeight).append("g").attr("transform","translate("+(pieWidth/2+pieLeftMargin)+","+pieHeight/2+")"),P=h.selectAll("path").data(p(pieSections)).enter().append("path").attr("fill",getColour).on("mouseover",i).on("mousemove",function(){return f.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return f.style("visibility","hidden")}).attr("d",b).each(function(t){this._current=t}),v=g.append("svg").attr("class","chart").attr("width","75%").attr("height",pieHeight).attr("y",10).append("g").attr("transform","translate("+barMargin.left+", "+barMargin.top+")");v.append("line").attr("x1",0).attr("x2",barWidth*(tradedVolume.length+1)).attr("y1",pieHeight+.5).attr("y2",pieHeight+.5).attr("stroke-width",.5).style("stroke","#000").attr("transform","translate(0, -40)");var y=d3.svg.axis().orient("left").scale(l).ticks(3).tickFormat(s),M=v.append("g").call(y);M.selectAll("path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges"),setTimeout(a,1e3)}}var colorbrewer={3:["rgb(252,141,89)","rgb(255,255,191)","rgb(153,213,148)"],4:["rgb(215,25,28)","rgb(253,174,97)","rgb(171,221,164)","rgb(43,131,186)"],5:["rgb(215,25,28)","rgb(253,174,97)","rgb(255,255,191)","rgb(171,221,164)","rgb(43,131,186)"],6:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],7:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],8:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],9:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],10:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"],11:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"]},pieWidth=160,pieHeight=200,pieLeftMargin,pieRadius=Math.min(pieWidth,pieHeight)/2,pieSections,barWidth=16,barMargin,tradedVolumeElements,runnerList,refreshButton,priceButtons,runnerLabels,latestPrices,numberOfRunners,colour,tradedVolume=[],timeSlot=0,lastTotal=0,maxVol=100,updatePriceButtons,getDepthButton,getPriceButton,getTooltipContainer,isChartShowing,isYui3,colourChooser=[function(t){return d3.rgb(colour(Math.floor(t/3))).darker(.3)},function(){return colour(numberOfRunners)},function(t){return d3.rgb(colour(Math.floor(t/3))).brighter(.3)}];!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.addEventListener("load",d3Plot,!1),t.src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js",document.body.appendChild(t)}();'>Betfair Charts</a> link onto your bookmark bar.  Then, on the Betfair web site, log in and navigate to a "Win Only Market" (i.e. not any form of Handicap market or other variant) such as football Match Odds, or Correct Score and click on the bookmark.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Slate theme maintained by <a href="https://github.com/jsncostello">Jason Costello</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

  </body>
</html>
c
