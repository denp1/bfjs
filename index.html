<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Slate is a responsive theme for GitHub Pages" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>BFJS: Betfair Javascript Charts</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/denp1/bfjs">View on GitHub</a>

          <h1 id="project_title">BFJS</h1>
          <h2 id="project_tagline">Betfair Javascript Charts</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <img alt="Betfair Charts in use" src="chart_screenshot.png" />
        <p>To use this bookmarklet, drag this <a href='javascript:var colorbrewer={3:["rgb(252,141,89)","rgb(255,255,191)","rgb(153,213,148)"],4:["rgb(215,25,28)","rgb(253,174,97)","rgb(171,221,164)","rgb(43,131,186)"],5:["rgb(215,25,28)","rgb(253,174,97)","rgb(255,255,191)","rgb(171,221,164)","rgb(43,131,186)"],6:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],7:["rgb(213,62,79)","rgb(252,141,89)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(153,213,148)","rgb(50,136,189)"],8:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],9:["rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)"],10:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"],11:["rgb(158,1,66)","rgb(213,62,79)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(230,245,152)","rgb(171,221,164)","rgb(102,194,165)","rgb(50,136,189)","rgb(94,79,162)"]},pieWidth=160,pieHeight=200,pieLeftMargin,pieRadius=Math.min(pieWidth,pieHeight)/2,pieSections,barWidth=16,barMargin,tradedVolumeElements,runnerList,refreshButton,priceButtons,runnerLabels,latestPrices,numberOfRunners,colour,tradedVolume=[],timeSlot=0,lastTotal=0,maxVol=100;var updatePriceButtons,getDepthButton,getPriceButton,getTooltipContainer,isChartShowing,isYui3;function mod(b,a){return b-(Math.floor(b/a)*a)}function getMaxPrice(a){return a?1:1/10000}var colourChooser=[function(a){return d3.rgb(colour(Math.floor(a/3))).darker(0.3)},function(a){return colour(numberOfRunners)},function(a){return d3.rgb(colour(Math.floor(a/3))).brighter(0.3)}];function getColour(b,a){return colourChooser[mod(a,3)](a)}function refreshPrices(){var a=document.createEvent("MouseEvents");a.initEvent("click",true,false);refreshButton.dispatchEvent(a)}function getMainDoc(){return d3.select(d3.select("#site_sports")[0][0].contentDocument).select("#main")[0][0].contentDocument}function grabPrices(){var c=[];for(i=0;i<numberOfRunners;i++){c[i]={};var b=priceButtons[2*i];var a=priceButtons[(2*i)+1];c[i].backPrice=getPrice(true,b);c[i].layPrice=getPrice(false,a);c[i].backDepth=getDepth(b);c[i].layDepth=getDepth(a);c[i].spread=c[i].backPrice-c[i].layPrice}return c}function getPrice(d,b){var c=b.childNodes[getPriceButton(b.childNodes.length)];if(c===undefined){return getMaxPrice(d)}var a=c.textContent.trim().replace(",","");if((a==="&nbsp;")||(a.length===0)){return getMaxPrice(d)}else{return 1/parseFloat(a)}}function getDepth(b){var c=b.childNodes[getDepthButton(b.childNodes.length)];if(c===undefined){return 0}var a=c.textContent.trim().replace(",","");return(a.length<2)?0:parseFloat(a.substring(1))}function updateVolumes(){newTotal=parseFloat(totalMatched()[0][0].textContent.substring(4).replace(/,/g,""));if(lastTotal!=0){tradedVolume.shift();tradedVolume.push({time:timeSlot++,value:newTotal-lastTotal})}maxVol=0;for(var a=0;a<tradedVolumeElements;a++){maxVol=Math.max(maxVol,tradedVolume[a].value)}lastTotal=newTotal}function updatePrices(){updateVolumes();priceButtons=updatePriceButtons();latestPrices=grabPrices();var d=latestPrices.reduce(function(o,n){return{backPrice:o.backPrice+n.backPrice}}).backPrice,g=latestPrices.reduce(function(o,n){return{layPrice:o.layPrice+n.layPrice}}).layPrice,e=latestPrices.reduce(function(o,n){return{spread:o.spread+n.spread}}).spread;for(i=0;i<numberOfRunners;i++){var k=g-latestPrices[i].layPrice,b=d-latestPrices[i].backPrice,h=Math.min(latestPrices[i].backPrice,1-k),f=Math.max(latestPrices[i].layPrice,1-b);latestPrices[i].rawRatio=(h+f)/2}var l=1-latestPrices.reduce(function(o,n){return{rawRatio:o.rawRatio+n.rawRatio}}).rawRatio;for(i=0;i<numberOfRunners;i++){latestPrices[i].overBy=latestPrices[i].spread*l/e;latestPrices[i].finalArc=latestPrices[i].overBy+latestPrices[i].rawRatio;var c=latestPrices[i].backDepth;var a=latestPrices[i].layDepth;if((c+a)===0){c=1;a=1}var j=latestPrices[i].spread*latestPrices[i].finalArc/2;pieSections[(i*3)]=(latestPrices[i].finalArc-j)*(c/(c+a));pieSections[(i*3)+1]=j*2;pieSections[(i*3)+2]=(latestPrices[i].finalArc-j)*(a/(c+a))}}function d3Plot(){if(window.d3===undefined){return}function t(x,y){if((typeof x=="undefined")||(x.length==0)){console.log(y);return false}return true}function w(){t(priceButtons,"priceButtons are not found");t(runnerList,"runnerList is not found");t(runnerLabels,"runnerLabels are not found")}function e(){if(isNewSite){pieLeftMargin=0;barMargin={top:20,right:20,bottom:20,left:40};tradedVolumeElements=27;priceButtons=d3.selectAll(".back .ng-scope, .lay .ng-scope")[0];filterFn=function(y,z){m=mod(z,6);return((m==2)||(m==3))};priceButtons=priceButtons.filter(filterFn);runnerList=d3.select(".runners-container");refreshButton=d3.select(".refresh-btn")[0][0];runnerLabels=runnerList.selectAll(".runner-name")[0];updatePriceButtons=function(){return priceButtons};getDepthButton=function(y){return 2};getPriceButton=function(y){return 0};getTooltipContainer=function(){return d3.select("body")};isChartShowing=function(){return d3.select("#chartDiv")[0][0]!==null};totalMatched=function(){return d3.select(".total-matched")};w()}else{pieLeftMargin=10;barMargin={top:20,right:20,bottom:20,left:40};tradedVolumeElements=30;var x=getMainDoc();updatePriceButtons=function(){return runnerList.selectAll(".l1 .buttonAppearance,.b1 .buttonAppearance")[0]};runnerList=d3.select(x).select("#runnerList");refreshButton=d3.select(x).select("#m1_btnRefresh")[0][0];priceButtons=updatePriceButtons();runnerLabels=runnerList.selectAll(".runnerName")[0];getDepthButton=function(y){return y-1};getPriceButton=function(y){return y-2};getTooltipContainer=function(){return b};isChartShowing=function(){return getMainDoc().getElementById("chartDiv")!==null};totalMatched=function(){return d3.select(x).select("#m1_TotalMoneyMatched")};w()}}isNewSite=d3.select(".runners-container")[0][0]!==null;e(isNewSite);for(var u=0;u<tradedVolumeElements;u++){tradedVolume[u]={time:timeSlot++,value:0}}var k=d3.scale.linear().domain([0,1]).range([0,barWidth]);var j=d3.scale.linear().domain([0,100]).rangeRound([pieHeight-barMargin.top-barMargin.bottom,0]);function s(){j.domain([0,Math.max(maxVol,100)]);v.call(a);var x=pieHeight-barMargin.top-barMargin.bottom;var y=p.selectAll("rect").data(tradedVolume,function(z){return z.time});y.enter().insert("rect","line").attr("x",function(A,z){return k(z+1)-0.5}).attr("y",function(z){return j(z.value)-0.5}).attr("width",barWidth).attr("height",function(z){return x-j(z.value)}).attr("fill","teal").transition().duration(1000).attr("x",function(A,z){return k(z)-0.5});y.transition().duration(1000).attr("x",function(A,z){return k(z)-0.5}).attr("y",function(z){return j(z.value)-0.5}).attr("height",function(z){return x-j(z.value)});y.exit().remove()}var n=[function(x,y){return"£"+y.backDepth+" to Back "+x+" @ "+(1/y.backPrice).toFixed(2)},function(x,y){return"Spread for "+x},function(x,y){return"£"+y.layDepth+" to Lay "+x+" @ "+(1/y.layPrice).toFixed(2)}];function g(A,x){var y=runnerLabels[Math.floor(x/3)].innerHTML;var z=latestPrices[Math.floor(x/3)];d.text(n[mod(x,3)](y,z));d.style("visibility","visible")}function l(){if(!isChartShowing()){return}refreshPrices();updatePrices();r.data(o(pieSections));r.transition().duration(750).attrTween("d",c);s();d3.timer.flush();setTimeout(l,1000)}function c(x){var y=d3.interpolate(this._current,x);this._current=y(0);return function(z){return f(y(z))}}runnerList.insert("div",":first-child").attr("id","chartDiv");numberOfRunners=priceButtons.length/2;pieSections=[numberOfRunners*3];var b=runnerList.select("#chartDiv");updatePrices();if(numberOfRunners<9){colour=d3.scale.ordinal().range(colorbrewer[numberOfRunners+1])}else{colour=d3.scale.category20()}var o=d3.layout.pie().sort(null);var f=d3.svg.arc().innerRadius(pieRadius-40).outerRadius(pieRadius);var d=getTooltipContainer().append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FAFCC5").style("opacity","0.85").style("font-size","12px").style("padding","3px");var q=b.append("svg").attr("width",pieWidth+pieLeftMargin).attr("height",pieHeight).append("g").attr("transform","translate("+((pieWidth/2)+pieLeftMargin)+","+pieHeight/2+")");var r=q.selectAll("path").data(o(pieSections)).enter().append("path").attr("fill",getColour).on("mouseover",g).on("mousemove",function(){return d.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px")}).on("mouseout",function(){return d.style("visibility","hidden")}).attr("d",f).each(function(x){this._current=x});var p=b.append("svg").attr("class","chart").attr("width","75%").attr("height",pieHeight).attr("y",10).append("g").attr("transform","translate("+barMargin.left+", "+barMargin.top+")");p.append("line").attr("x1",0).attr("x2",barWidth*(tradedVolume.length+1)).attr("y1",pieHeight+0.5).attr("y2",pieHeight+0.5).attr("stroke-width",0.5).style("stroke","#000").attr("transform","translate(0, -40)");var a=d3.svg.axis().orient("left").scale(j).ticks(3).tickFormat(h);function h(A){var x=A;var y="";var z=d3.format(".0f");if(A>=1000){x=A/1000;y="k";if(mod(A,1000)!==0){z=d3.format(".1f")}}else{if(A>=1000000){x=A/1000000;y="m";if(mod(A,1000000)!==0){z=d3.format(".1f")}}}return"£"+z(x)+y}var v=p.append("g").call(a);v.selectAll("path").style("fill","none").style("stroke","#000").style("shape-rendering","crispEdges");setTimeout(l,1000)}(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.addEventListener("load",d3Plot,false);a.src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js";document.body.appendChild(a)})();'>Betfair Charts</a> link onto your bookmark bar.  Then, on the Betfair web site, log in and navigate to a "Win Only Market" (i.e. not any form of Handicap market or other variant) such as football Match Odds, or Correct Score and click on the bookmark.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Slate theme maintained by <a href="https://github.com/jsncostello">Jason Costello</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

  </body>
</html>
c
